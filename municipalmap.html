<!-- type into terminal before running: php -S 127.0.0.1:8000-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Jersey Energy Portal</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


    <!-- Used for icons-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!---------------------------------------------------CSS Section------------------------------------------------------>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: gill sans, sans-serif;
            background-color: #04A264;
            height: 100%;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .top-sidebar {
            flex: 0 0 0px;
            background-color: #0a2a1f;
            color: white;
            padding: 20px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .top-sidebar h1 {
            font-size: 18px;
            text-transform: uppercase;
            margin: 0;
        }

        .main-content {
            display: flex;
            flex: 1;
        }

        /* Back Button on Navbar */
        .back-button {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background-color: #0a2a1f;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
        }


  /* ----------------------------- Tabbed Filter Buttons (Left Panel) ----------------------------- */
        .filter-toggle-button,
        .utility-toggle-button,
        .income-toggle-button,
        .tenure-toggle-button,
        .race-toggle-button {
            position: fixed;
            left: 0;
            background-color: #0a2a1f;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            z-index: 10;
        }

        .filter-toggle-button { 
            top: 20%; transform: translateY(-50%); 
        }
        .utility-toggle-button { 
            top: 25%; transform: translateY(-50%); 
        }
        .income-toggle-button { 
            top: 30%; transform: translateY(-50%); 
        }
        .tenure-toggle-button { 
            top: 35%; transform: translateY(-50%); 
        }
        .race-toggle-button { 
            top: 40%; transform: translateY(-50%); 
        }

/* ----------------------------- Dropdown Filter Panels ----------------------------- */
        .filter-tab,
        .utility-dropdown,
        .income-dropdown,
        .tenure-dropdown,
        .race-dropdown {
            display: none;
            position: absolute;
            left: 85px;
            background-color: #04A264;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 15;
            width: 210px;
            color: white;
            overflow-y: auto;
        }

        .filter-tab { 
            top: 15%; 
        }
        .utility-dropdown { 
            top: 20%; 
        }
        .income-dropdown { 
            top: 28%; 
        }
        .tenure-dropdown { 
            top: 40%; 
        }
        .race-dropdown { 
            top: 60%; 
        }

/* ----------------------------- Buttons Inside Dropdowns ----------------------------- */
        .dropdown-btn,
        .income-dropdown-btn,
        .tenure-dropdown-btn,
        .race-dropdown-btn {
            background-color: #04A264;
            color: white;
            width: 130px;
            height: 50px;
            border: none;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-align: center;
        }

        .dropdown-btn:hover,
        .income-dropdown-btn:hover,
        .tenure-dropdown-btn:hover,
        .race-dropdown-btn:hover {
            background-color: #037c4d;
        }


        /* ------------------------------------------ End of Tabbed Filters on Left Panel ----------------------------------------------- */

        /* --------------------------------------------- Green Drop down Right Panel Function ---------------------------------------- */
        /* Drop down for when a user clicks on a county*/
        .green-dropdown {
            display: none;
            position: absolute;
            top: 80px;
            /* Adjust position from top*/
            left: 82%;
            transform: translateX(-50%);
            background-color: #04A264;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            width: 500px;
            /* Adjust width of green box */
            max-height: 85vh;
            /* Adjusts the size of the green box*/
            text-align: center;
            z-index: 1000;
            overflow-y: auto;
        }

        /* Optional: Style the scrollbar */
        .green-dropdown::-webkit-scrollbar {
            width: 8px;
            /* Width of the scrollbar */
        }

        .green-dropdown::-webkit-scrollbar-thumb {
            background-color: #037c4d;
            /* Color of the scrollbar thumb */
            border-radius: 10px;
            /* Rounded corners for the scrollbar thumb */
        }

        .green-dropdown::-webkit-scrollbar-track {
            background-color: #e6f7ee;
            /* Background of the scrollbar track */
        }

        .green-dropdown.visible {
            display: block;
            /* Show the dropdown */
        }

        /* ----------------------------------------- End of Green Drop Down Right Panel ---------------------------------------------- */

        /* ------------------------------------------------- Map Functionalities ----------------------------------------------------- */
        #map-container {
            position: absolute;
            top: 60px;
            left: 0%;
            width: 100%;
            height: calc(100vh - 60px);
            z-index: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ---------------------------------------------- End of Map Functionalities ------------------------------------------------- */



        /* ---------------------------------------------------- Calculator Function ----------------------------------------------------- */
        .calculator-widget {
            position: fixed;
            bottom: 10px;
            right: 20px;
            /* Adjusted to move the positioning of the button */
            background-color: #04A264;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            text-align: center;
            font-size: 24px;
            /* Icon size */
        }

        /* Calculator pops for user interaction */
        .calculator-popup {
            display: none;
            position: fixed;
            bottom: 60px;
            right: 80px;
            background-color: white;
            color: black;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            width: 250px;
            z-index: 10;
        }

        .calculator-popup label {
            display: block;
            margin-top: 10px;
        }

        .calculator-popup input,
        .calculator-popup select {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .calculator-popup button {
            margin-top: 15px;
            background-color: #04A264;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .calculator-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background-color: #f0f0f0;
            color: black;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            /* Add horizontal spacing between buttons */
            border-radius: 5px;
            /* Optional: Add rounded corners for better aesthetics */
        }

        .active-tab {
            background-color: #04A264;
            color: white;
        }

        /* Tips section in calculator*/
        .tips-box {
            display: none;
            position: fixed;
            top: 20.5%;
            right: 46%;
            width: 80%;
            max-width: 600px;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            overflow-y: auto;
            max-height: 70%;
        }

        .tips-content h3 {
            font-size: 20px;
            color: #04A264;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tips-content ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .tips-content ul li {
            margin-bottom: 15px;
            padding: 10px;
            background: #e6f7ee;
            border-left: 4px solid #04A264;
            border-radius: 5px;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
        }

        .tips-content ul li strong:first-of-type {
            font-weight: bold;
            color: #333;
        }

        .tips-content ul li strong:not(:first-of-type) {
            color: #04A264;
            font-weight: normal;
        }

        .tips-content button {
            background-color: #04A264;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            transition: background-color 0.3s ease;
        }

        .tips-content button:hover {
            background-color: #037c4d;
        }

        .tips-box::-webkit-scrollbar {
            width: 8px;
        }

        .tips-box::-webkit-scrollbar-thumb {
            background-color: #04A264;
            border-radius: 10px;
        }

        /* ----------------------------------------------- End of Calculator widget ---------------------------------------------*/

        /* ----------------------------------------------- Legend Function ------------------------------------------------------ */
        /* Legend for the map */
        .info.legend {
            background: white;
            padding: 6px 10px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        .info.legend i {
            width: 25px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.85;
        }

        .info.legend h4 {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .leaflet-bottom.leaflet-left .info.legend {
            left: 10px;    /* move horizontally */
            bottom: 125px;  /* move vertically */
        }


        /* ----------------------------------------------- End of Legend Function ------------------------------------------------- */
    </style>
</head>

<!-----------------------------------------------HTML Section--------------------------------------------------------->

<body>
    <!-- Back Button -->
    <a href="dashboardrevised.html" class="back-button">← Back County Level</a>

    <div class="container">
        <!-- Navbar -->
        <div class="top-sidebar">
            <h1>New Jersey Energy Portal</h1>
        </div>

        <!-- Map Container -->
        <div id="map-container">
            <div id="map"></div>
        </div>

        <!-- Filter Toggle Button -->
        <button class="filter-toggle-button" onclick="toggleFilter()">OBC</button>

        <div class="filter-tab" id="filter-tab">
            <!-- Left Panel -->
            <!-- These are for all the filters that will be used-->
            <div class="filter-container">

                <!-- Add button to turn on overburdened communities-->
                <button id="toggleOBC"
                    style="margin-top: 10px; background-color: #fff; color: #04A264; border: 1px solid #04A264; padding: 5px; border-radius: 5px; cursor: pointer;">
                    Toggle Overburdened Communities
                </button>

                <!--Creates a space between filters-->
                <div style="margin: 10px 0;"></div>

                <!-- County Filters -->
                <label for="county-filter">County:</label>
                <select id="county-filter">
                    <option value="all">Select a County</option>
                    <option value="ATLANTIC">Atlantic</option>
                    <option value="BERGEN">Bergen</option>
                    <option value="BURLINGTON">Burlington</option>
                    <option value="CAMDEN">Camden</option>
                    <option value="CAPE MAY">Cape May</option>
                    <option value="CUMBERLAND">Cumberland</option>
                    <option value="ESSEX">Essex</option>
                    <option value="GLOUCESTER">Gloucester</option>
                    <option value="HUDSON">Hudson</option>
                    <option value="HUNTERDON">Hunterdon</option>
                    <option value="MERCER">Mercer</option>
                    <option value="MIDDLESEX">Middlesex</option>
                    <option value="MONMOUTH">Monmouth</option>
                    <option value="MORRIS">Morris</option>
                    <option value="OCEAN">Ocean</option>
                    <option value="PASSAIC">Passaic</option>
                    <option value="SALEM">Salem</option>
                    <option value="SOMERSET">Somerset</option>
                    <option value="SUSSEX">Sussex</option>
                    <option value="UNION">Union</option>
                    <option value="WARREN">Warren</option>
                </select>

                <!-- Creates a space between filters-->
                <div style="margin: 10px 0;"></div>
            </div>
        </div>
        <!-- Utility -->
        <button class="utility-toggle-button" onclick="toggleUtility()">Utility</button>
        

        <!-- Utility Dropdown Menu -->
        <div id="utility-dropdown" class="utility-dropdown">
            <!--
            <button id="toggleUtilityLayer"
                style="margin-top: 10px; background-color: #fff; color: #04A264; border: 1px solid #04A264; padding: 5px; border-radius: 5px; cursor: pointer;">
                Toggle Utility Layer </button>
            -->
            
            <br>
            <label for="year-select"> Select Year:<br> </label>
            <select id="year-select" onchange="updateUtilityRightPanel()">
                <option value="all">Select a Year</option>
                <option value="2016">2016</option>
                <option value="2017">2017</option>
                <option value="2018">2018</option>
                <option value="2019">2019</option>
                <option value="2020">2020</option>
                <option value="2021">2021</option>
                <option value="2022">2022</option>
            </select>
            <br>

            <label for="utility-county-filter">Select County:</label>
            <select id="utility-county-filter" onchange="updateUtilityRightPanel()">
                <option value="all">Select a County</option>
                <option value="Atlantic">Atlantic</option>
                <option value="Bergen">Bergen</option>
                <option value="Burlington">Burlington</option>
                <option value="Camden">Camden</option>
                <option value="Cape May">Cape May</option>
                <option value="Cumberland">Cumberland</option>
                <option value="Essex">Essex</option>
                <option value="Gloucester">Gloucester</option>
                <option value="Hudson">Hudson</option>
                <option value="Hunterdon">Hunterdon</option>
                <option value="Mercer">Mercer</option>
                <option value="Middlesex">Middlesex</option>
                <option value="Monmouth">Monmouth</option>
                <option value="Morris">Morris</option>
                <option value="Ocean">Ocean</option>
                <option value="Passaic">Passaic</option>
                <option value="Salem">Salem</option>
                <option value="Somerset">Somerset</option>
                <option value="Sussex">Sussex</option>
                <option value="Union">Union</option>
                <option value="Warren">Warren</option>
            </select>
            <br>
            

            <label for="fuel-type-select">Select Fuel Type:</label>
            <select id="fuel-type-select" onchange="updateUtilityRightPanel()">
                <option value="all">Select a Fuel Type</option>
                <option value="electricity">Residential Electricity</option>
                <option value="naturalGas">Residential Natural Gas</option>
            </select>

            <!-- Reset Button -->
            <button id="reset-utility-filters"
                style="margin-top: 10px; background-color: #fff; color: #04A264; border: 1px solid #04A264; padding: 5px; border-radius: 5px; cursor: pointer;">
                Reset Filters
            </button>
        </div>

        <!--Income-->
        <button class="income-toggle-button" onclick="toggleIncome()">Income</button>
        <div id="income-dropdown" class="income-dropdown">
            <p>Income filter placeholder</p>
        </div>

        <!--Tenure-->
        <button class="tenure-toggle-button" onclick="toggleTenure()">Tenure</button>
        <div id="tenure-dropdown" class="income-dropdown">
            <p>Tenure filter placeholder</p>
        </div>

        <!--Race-->
        <button class="race-toggle-button" onclick="toggleRace()">Race</button>
        <div id="race-dropdown" class="income-dropdown">
            <p>Race filter placeholder</p>
        </div>


        <!-- legend box -->
        <div id="legend" class="info legend leaflet-bottom leaflet-left"></div>

        <!-- Calculator Widget Icon-->
        <div class="calculator-widget" onclick="toggleCalculator()">
            <i class="fas fa-calculator"></i>
        </div>


        <!--For the Calculator to pop up-->
        <div class="calculator-popup" id="calculator-popup">
            <h2 style="font-weight: bold; margin-bottom: 10px;">Calculate your Energy Burden</h2>

            <label for="income-input">Enter your annual gross income: </label>
            <input type="text" id="income-input" placeholder="Enter Gross Income" />
            <br>
            <label for="energy-output">Enter your annual utilities expenses: </label>
            <input type="text" id="energy-output" placeholder="Enter Annual Utility Expenditure" />
            <button id="calculate-btn">Calculate</button>
            <div id="calculator-result" style="margin-top: 15px;"></div>
        </div>


        <!--Calculator Tips for lowering energy burden-->
        <div class="tips-box" id="tips-box">
            <div class="tips-content">
                <h3>Tips to Lower Energy Burden</h3>
                <ul>
                    <li id="energy-burden-message">
                        <strong>Your energy burden is X%, which is higher than the state average of 2-3%.</strong>
                        Have you looked into programs like the <strong>Low-Income Home Energy Assistance Program
                            (LIHEAP)</strong>?
                        It can help with your energy costs and even pay for home weatherization to reduce future bills.
                    </li>
                    <li><strong>Did you know reducing your energy burden doesn’t always mean big changes?</strong>
                        Small actions like sealing air leaks around windows and doors or adding insulation can make your
                        home more energy-efficient, keeping heating and cooling costs down.</li>
                    <li><strong>Have you considered joining a community solar program?</strong>
                        This allows you to subscribe to a shared solar energy source without the cost of installing
                        panels. It’s a great way to reduce your electricity bills and your carbon footprint.</li>
                    <li><strong>The energy burden in your area is above average, but there are tools to help.</strong>
                        The <strong>Comfort Partners Program</strong> provides free energy-saving upgrades for eligible
                        households, helping reduce energy use and costs over the long term.</li>
                    <li><strong>High energy costs can feel overwhelming, but you don’t have to face them alone.</strong>
                        Contact your utility provider about <strong>budget billing plans</strong> or <strong>payment
                            assistance programs</strong>, which can spread out costs and make bills more manageable.
                    </li>
                    <li><strong>Did you know weatherization can significantly lower your energy burden?</strong>
                        Programs like the <strong>Weatherization Assistance Program (WAP)</strong> can provide free
                        services
                        to improve your home’s energy efficiency, such as adding insulation or repairing your heating
                        system.</li>
                    <li><strong>Are you eligible for energy-efficient appliance rebates?</strong>
                        Replacing older appliances with <strong>ENERGY STAR-certified models</strong> can reduce your
                        energy
                        use, and rebates through the <strong>New Jersey Clean Energy Program</strong> make them more
                        affordable.</li>
                </ul>
                <button onclick="closeTips()">Close</button>
            </div>
        </div>         


        <!----------------------------------------------------JavaScript Section------------------------------------->
        <!-- Leaflet -->

        <!-- Map Loading -->
        <script>
            const map = L.map('map').setView([39.90, -74.40], 8);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            let geojsonLayer;
            let muniGeoJSONData = null;
            let hoveredMunicipalId = null;
            let selectedMunicipalId = null;
            let countyGeoJSON = null; // Store the GeoJSON data globally

            //function to help keep municipalities on top to allow hover to work
            function ensureUtilityLayerOnTop() {
                if (utilityLayer && map.hasLayer(utilityLayer)) {
                    utilityLayer.bringToFront();
                    console.log("[Layer Priority] utilityLayer brought to front.");
                }
            }

            // Load NJ County Borders
            fetch('https://maps.nj.gov/arcgis/rest/services/Framework/Government_Boundaries/MapServer/1/query?outFields=*&where=1%3D1&f=geojson')
                .then(response => response.json())
                .then(data => {
                    countyGeoJSON = data; // Store the county GeoJSON globally

                    geojsonLayer = L.geoJSON(data, {
                        style: {
                            color: '#0000FF',
                            weight: 2,
                            fillColor: 'transparent',
                            fillOpacity: 0
                        }
                    }).addTo(map);
                    utilityLayer.bringToFront();

                    console.log("County borders layer added.");
                })
                .catch(error => console.error("Error loading county data:", error));


            //loads municipalities 
            fetch('https://services2.arcgis.com/XVOqAjTOJ5P6ngMu/arcgis/rest/services/NJ_Municipal_Boundaries_3424/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson')
                .then(response => response.json())
                .then(data => {
                    muniGeoJSONData = data;
                    utilityLayer = L.geoJSON(muniGeoJSONData, {
                        style: feature => ({
                            fillColor: '#D3D3D3',
                            weight: 0.5,
                            color: '#627BC1',
                            fillOpacity: 0.5
                        }),
                        onEachFeature: function (feature, layer) {
                            const muniName = feature.properties.MUN;
                            
                            // Shows municipality name name when hovering
                            layer.bindTooltip(feature.properties.MUN, {
                                permanent: false,
                                direction: 'top',
                                offset: [0, -10],
                                opacity: 0.9,
                                className: 'muni-tooltip',
                            });

                            // Hover behavior
                            layer.on({
                                mouseover: function (e) {
                                    e.target.setStyle({
                                        fillOpacity: 0.9,
                                        color: '#00441b',
                                        weight: 3
                                    });
                                    layer.openTooltip();
                                },
                                mouseout: function (e) {
                                    e.target.setStyle({
                                        fillOpacity: 0.75, // match the default or filtered state
                                        color: '#627BC1',
                                        weight: 1,
                                        fillColor: e.target.feature.properties._originalColor || '#D3D3D3'
                                    });
                                    layer.closeTooltip();
                                }
                            });
                        }, 
                        interactive: true
                    }).addTo(map);
                    console.log("Loaded municipal boundaries once and initialized utility layer.");
                })
                .catch(error => console.error('Error fetching municipal boundaries:', error));
        
/*--- Calculator --- */            
            //calculator pop up function
            function toggleCalculator() {
                const popup = document.getElementById('calculator-popup');
                popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
            }


            // Event listener for the calculate button
            document.getElementById('calculate-btn').addEventListener('click', function () {
                // Get user input for income and utility expenses
                const income = parseFloat(document.getElementById('income-input').value);
                const energyOutput = parseFloat(document.getElementById('energy-output').value);

                // Check if the input is valid
                if (isNaN(income) || income <= 0 || isNaN(energyOutput) || energyOutput < 0) {
                    document.getElementById('calculator-result').innerHTML = `<p style="color:red;">Please enter valid income and utility expense values.</p>`;
                    return;
                }

                // Calculate the energy burden percentage
                const energyBurden = (energyOutput / income) * 100;

                // Determine the result message based on the energy burden
                let statusTitle;
                let statusMessage;
                let tipsLink = '';

                if (energyBurden > 3) {
                    // Overburden (greater than 3%)
                    statusTitle = `<p style="color:red;"><strong>Overburdened</strong></p>`;
                    statusMessage = `<p>Your energy burden is ${energyBurden.toFixed(2)}%, which is above the threshold of 3%.</p>`;
                    // Show the tips link
                    tipsLink = `<p style="cursor: pointer; color: #04A264;" onclick="showTips()"><< Tips for Lowering Energy Burden</p>`;
                } else {
                    // Below 3% (not overburdened)
                    statusTitle = `<p style="color:green;"><strong>Below Threshold</strong></p>`;
                    statusMessage = `<p>Your energy burden is ${energyBurden.toFixed(2)}%, which is below the 3% threshold.</p>`;
                }

                // Display the energy burden result
                document.getElementById('calculator-result').innerHTML = `
                    <p><strong>Energy Burden:</strong> ${energyBurden.toFixed(2)}%</p>
                    <div style="margin-top: 15px;"></div>
                    ${statusTitle}
                    ${statusMessage}
                    <div style="margin-top: 15px;"></div>
                    ${tipsLink}`;

                // Update the energy burden message in the list item
                document.getElementById('energy-burden-message').innerHTML = `
                    <strong>Your energy burden is ${energyBurden.toFixed(2)}%, which is higher than the state average of 2-3%.</strong>`;
            });


            // JavaScript functions to handle the tips box
            function showTips() {
                document.getElementById('tips-box').style.display = 'block';
            }

            // Close the tips box
            function closeTips() {
                document.getElementById('tips-box').style.display = 'none';
            }

            // Toggle the visibility of the calculator popup
            function toggleCalculator() {
                const popup = document.getElementById('calculator-popup');
                popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
            }
/*--- End of Calculator functionalities ---*/                


/*--- Overburdened Community */
            // Define the ArcGIS Feature Service URL
            const obcUrl = "https://services1.arcgis.com/QWdNfRs7lkPq4g4Q/arcgis/rest/services/Overburdened_Communities_under_the_New_Jersey_Environmental_Justice_Law/FeatureServer/19/query?where=1%3D1&outFields=POVUNIVERSE,POPUNDER2XPOV,LOW_INCOME_PCT,TOTALPOP,NONHISPWHITE,TOTALMINORITY,MINORITY_PCT,TOTHH,TOTLANGUAGEISO,PCTLINGUAGEISO,OVERBURDENED_COMMUNITY_CRITERI,BG_TRIBAL,COUNTY,NAME,SPLIT_BG,SPLIT_MUN&outSR=4326&f=geojson";


            // Function to fetch all results
            async function fetchAllResults() {
                const results = [];
                let offset = 0;
                const limit = 1000;

                const baseUrl = "https://services1.arcgis.com/QWdNfRs7lkPq4g4Q/arcgis/rest/services/Overburdened_Communities_under_the_New_Jersey_Environmental_Justice_Law/FeatureServer/19/query";

                while (true) {
                    const params = new URLSearchParams({
                        where: "1=1",
                        outFields: "POVUNIVERSE,POPUNDER2XPOV,LOW_INCOME_PCT,TOTALPOP,NONHISPWHITE,TOTALMINORITY,MINORITY_PCT,TOTHH,TOTLANGUAGEISO,PCTLINGUAGEISO,OVERBURDENED_COMMUNITY_CRITERI,BG_TRIBAL,COUNTY,NAME,SPLIT_BG,SPLIT_MUN",
                        outSR: "4326",
                        f: "geojson",
                        resultOffset: offset,
                        resultRecordCount: limit
                    });

                    const url = `${baseUrl}?${params.toString()}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (!data.features || data.features.length === 0) {
                        break;
                    }

                    results.push(...data.features);
                    offset += limit;
                    console.log(`[OBC] Loaded ${offset} features so far...`);
                }

                console.log(`[OBC] Fetched total ${results.length} features.`);
                return {
                    type: "FeatureCollection",
                    features: results
                };
            }


            function getOverburdenedColor(criteria) {
                switch (criteria) {
                    case 'Low Income and Minority': return '#F7FCF0';
                    case 'Minority': return '#C7E9C0';
                    case 'Low Income, Minority, and Limited English': return '#74C476';
                    case 'Low Income and Limited English': return '#238B45';
                    case 'Low Income': return '#126830';
                    case 'Limited English': return '#095626';
                    case 'Minority and Limited English': return '#4CA85E';
                    case 'Adjacent': return '#00441B';
                    default: return '#000000';
                }
            }

            function showOBCLegend() {
                const legend = document.getElementById("legend");
                legend.innerHTML = `<h4>Overburdened Community Criteria</h4>`;

                const categories = {
                    "Low Income and Minority": "#F7FCF0",
                    "Minority": "#C7E9C0",
                    "Low Income, Minority, and Limited English": "#74C476",
                    "Low Income and Limited English": "#238B45",
                    "Low Income": "#126830",
                    "Limited English": "#095626",
                    "Minority and Limited English": "#4CA85E",
                    "Adjacent": "#00441B"
                };

                for (const [label, color] of Object.entries(categories)) {
                    legend.innerHTML += `
                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                            <div style="width: 20px; height: 20px; background:${color}; border: 1px solid #999; margin-right: 8px;"></div>
                            <span>${label}</span>
                        </div>`;
                }
            }



            let obcDataCache = null;
            let obcLayer = null;

            // Independent Zoom Function
            function zoomToCounty(countyName) {
                const encodedCounty = encodeURIComponent(countyName.trim().toUpperCase());
                const url = `https://maps.nj.gov/arcgis/rest/services/Framework/Government_Boundaries/MapServer/1/query?where=UPPER(COUNTY)='${encodedCounty}'&outFields=*&f=geojson`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (!data || !data.features || data.features.length === 0) {
                            console.warn("No data returned for county:", countyName);
                            return;
                        }

                        const bounds = L.geoJSON(data).getBounds();
                        if (bounds.isValid()) {
                            map.fitBounds(bounds, {
                                padding: [40, 40],
                                maxZoom: 12
                            });
                            console.log(`[Zoom] Zoomed to ${countyName}`);
                        } else {
                            console.warn(`[Zoom] Invalid bounds for ${countyName}`);
                        }
                    })
                    .catch(err => {
                        console.error("[Zoom] Fetch error:", err);
                    });
            }

            // Zoom anytime the county changes
            document.getElementById("county-filter").addEventListener("change", function () {
                const selectedCounty = this.value?.toUpperCase();
                if (selectedCounty && selectedCounty !== "ALL") {
                    console.log("[Zoom] County selected:", selectedCounty);
                    zoomToCounty(selectedCounty);
                } else {
                    console.log("[Zoom] Reset to full NJ view");
                    map.setView([40.0583, -74.4057], 7); // Default view
                }
            });

            // OBC Toggle — completely independent of zoom
            document.getElementById('toggleOBC').addEventListener('click', async function () {
                if (obcLayer && map.hasLayer(obcLayer)) {
                    map.removeLayer(obcLayer);
                    obcLayer = null;
                    document.getElementById("legend").innerHTML = "";
                    console.log("[OBC] Layer removed.");
                    return;
                }

                console.log("[OBC] Fetching and displaying OBC layer...");
                try {
                    const geojson = await fetchAllResults();

                    obcLayer = L.geoJSON(geojson, {
                        style: feature => ({
                            fillColor: getOverburdenedColor(feature.properties.OVERBURDENED_COMMUNITY_CRITERI),
                            fillOpacity: 0.75,
                            weight: 1,
                            color: '#000000'
                        }),
                        onEachFeature: (feature, layer) => {
                            const props = feature.properties;
                            const popupHTML = `
                                <strong>Municipality:</strong> ${props.NAME}<br>
                                <strong>County:</strong> ${props.COUNTY}<br>
                                <strong>Burden Factors:</strong> ${props.OVERBURDENED_COMMUNITY_CRITERI}
                            `;
                            layer.bindPopup(popupHTML);
                            layer.on('mouseenter', () => map.getContainer().style.cursor = 'pointer');
                            layer.on('mouseleave', () => map.getContainer().style.cursor = '');
                        }
                    }).addTo(map);
                    obcLayer.bringToFront();
                    //ensureUtilityLayerOnTop();

                    showOBCLegend();
                    console.log("[OBC] Layer added.");
                } catch (err) {
                    console.error("[OBC] Failed to load:", err);
                }
            });


            //tab function on filters
            function toggleFilter() {
                var dropdown = document.getElementById("filter-tab");
                dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
            }
/*--- end of filter tab functionalities ---*/

/*--- Utility Tab Filter Functionalities ---*/

            // Color Scale for Heating Filter
            function getUtilityColor(d, fuelType) {
                if (fuelType === "electricity") {
                    return d > 500000000 ? '#800026' :
                        d > 100000000 ? '#BD0026' :
                        d > 10000000  ? '#E31A1C' :
                        d > 1000000   ? '#FD8D3C' :
                        d > 100000    ? '#FEB24C' :
                        d > 10000     ? '#FFEDA0' :
                        d >= 0        ? '#f7f7f7' :
                                        '#D3D3D3';
                }else if (fuelType === "naturalGas") {
                    return d > 50000000 ? '#800026' :
                        d > 10000000 ? '#BD0026' :
                        d > 1000000  ? '#E31A1C' :
                        d > 100000   ? '#FD8D3C' :
                        d > 10000    ? '#FEB24C' :
                        d > 1000     ? '#FFEDA0' :
                        d >= 0       ? '#f7f7f7' :
                                        '#D3D3D3';
                } else {
                    return '#D3D3D3'; // fallback for "all" or unknown
                }

                if (!utilityValue || utilityValue === "NDA") return;
            }

            function updateLegend(fuelType) {
                const legend = document.getElementById("legend");
                legend.innerHTML = `<h4>${fuelType === "electricity" ? "Residential Electricity" : "Residential Natural Gas"}</h4>`;

                const grades = fuelType === "electricity"
                    ? [10000, 100000, 1000000, 10000000, 100000000, 500000000]
                    : [1000, 10000, 100000, 1000000, 10000000, 50000000];

                grades.forEach((from, i) => {
                    const to = grades[i + 1];
                    const color = getUtilityColor(from + 1, fuelType); // from+1 ensures it's in the right bucket

                    legend.innerHTML += `
                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                            <div style="width: 20px; height: 20px; background:${color}; border: 1px solid #999; margin-right: 8px;"></div>
                            <span>${from.toLocaleString()}${to ? " – " + to.toLocaleString() : "+"}</span>
                        </div>`;
                });

                // Add NDA box
                legend.innerHTML += `
                    <div style="display: flex; align-items: center; margin-top: 10px;">
                        <div style="width: 20px; height: 20px; background:#D3D3D3; border: 1px solid #999; margin-right: 8px;"></div>
                        <span>No Data (NDA)</span>
                    </div>`;
            }

/*
            //toggle utility layer visibility 
            let utilityLayer = null; // Define globally

            fetch('https://services2.arcgis.com/XVOqAjTOJ5P6ngMu/arcgis/rest/services/NJ_Municipal_Boundaries_3424/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson')
                .then(response => response.json())
                .then(data => {
                    utilityLayer = L.geoJSON(data, {
                        style: function (feature) {
                            return {
                                fillColor: '#74c476', // Default placeholder color
                                fillOpacity: 0.75,
                                weight: 1,
                                color: '#000'
                            };
                        }
                    });

                    console.log("Utility layer loaded.");
                })
                .catch(error => console.error('Error fetching municipal boundaries:', error));
*/

            //when clicking utility 
            function toggleUtility() {
                var dropdown = document.getElementById("utility-dropdown");
                //toggle visibility
                dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
            }

            document.getElementById('reset-utility-filters').addEventListener('click', function () {
                //reset filters
                document.getElementById('year-select').value = 'all';
                document.getElementById('utility-county-filter').value = 'all';
                document.getElementById('fuel-type-select').value = 'all';
                updateUtilityRightPanel();

                //hide right panel
                let dropdown = document.querySelector('.green-dropdown');
                if (dropdown) {
                    dropdown.classList.remove('visible');
                }

                //reset map choropleth 
                map.eachLayer(layer => {
                    if (layer.features && layer.feature.properties) {
                        layer.setStyle({
                            fillColor: 'transparent',
                            fillOpacity: 0,
                            color: '#627BC1',
                            weight: 2
                        });
                    }
                });
            });

/*--- Additional Tabs ---*/
            function toggleIncome() {
                const box = document.getElementById("income-dropdown");
                box.style.display = box.style.display === "block" ? "none" : "block";
            }
            function toggleTenure() {
                const box = document.getElementById("tenure-dropdown");
                box.style.display = box.style.display === "block" ? "none" : "block";
            }
            function toggleRace() {
                const box = document.getElementById("race-dropdown");
                box.style.display = box.style.display === "block" ? "none" : "block";
            }



    /*--- Right Panel --- */
            // Right panel update function for Leaflet
            function updateUtilityRightPanel() {
                const year = document.getElementById('year-select').value;
                const county = document.getElementById('utility-county-filter').value;
                const fuelType = document.getElementById('fuel-type-select').value;

                const params = new URLSearchParams();
                if (year !== "all") params.append("year", year);
                if (county !== "all") params.append("county", county);
                if (fuelType === "electricity") {
                    params.append("residential Electricity", 1);
                } else if (fuelType === "naturalGas") {
                    params.append("residential NaturalGas", 1);
                }

                fetch(`getdata_all.php?${params.toString()}`)
                    .then(response => response.json())
                    .then(data => {
                        const dropdown = document.querySelector('.green-dropdown') || document.createElement('div');
                        dropdown.className = 'green-dropdown';
                        if (!document.body.contains(dropdown)) document.body.appendChild(dropdown);
                        

                        // Build panel content
                        let content = `<h2>Utility Data</h2><table border="0" style="width: 100%; margin-top: 10px;">`;
                        content += `
                            <tr>
                                <th>Municipality</th>
                                <th>County</th>
                                <th>Year</th>
                                ${fuelType === "electricity" ? "<th>Residential Electricity</th>" : ""}
                                ${fuelType === "naturalGas" ? "<th>Residential Natural Gas</th>" : ""}
                                ${fuelType === "all" ? "<th>Residential Electricity</th><th>Residential Natural Gas</th>" : ""}
                            </tr>`;

                        // Build fast lookup table
                        const muniLookup = {};
                        data.forEach(row => {
                            const muniName = row["Municipality"]?.toUpperCase().trim();
                            if (muniName && (county === "all" || row["County"] === county)) {
                                muniLookup[muniName] = row;
                            }

                            content += `
                                <tr>
                                    <td>${row["Municipality"]}</td>
                                    <td>${row["County"]}</td>
                                    <td>${row["Year"]}</td>
                                    ${fuelType === "electricity" ? `<td>${row["Residential Electricity"] || '-'}</td>` : ""}
                                    ${fuelType === "naturalGas" ? `<td>${row["Residential Natural Gas"] || '-'}</td>` : ""}
                                    ${fuelType === "all" ? `
                                        <td>${row["Residential Electricity"] || '-'}</td>
                                        <td>${row["Residential Natural Gas"] || '-'}</td>` : ""}
                                </tr>`;
                        });

                        //ensure the utilityLayer is on the map
                        if (!map.hasLayer(utilityLayer)) {
                            utilityLayer.addTo(map);
                        }

                        // Update map colors
                        utilityLayer.eachLayer(layer => {
                            const muniProp = layer.feature?.properties?.MUN?.toUpperCase().trim();
                            const row = muniLookup[muniProp];

                            if (!row) return;

                            let utilityValue = fuelType === "electricity"
                                ? row["Residential Electricity"]
                                : row["Residential Natural Gas"];

                            if (!utilityValue || utilityValue === "NDA") {
                                console.warn(`[Utility] No data or NDA for: ${muniProp}`);
                                return;
                            }

                            if (typeof utilityValue === "string") {
                                utilityValue = utilityValue.replace(/,/g, "").trim();
                            }
                            utilityValue = parseFloat(utilityValue);

                            if (!isNaN(utilityValue)) {
                                layer.setStyle({
                                    fillColor: getUtilityColor(utilityValue, fuelType),
                                    fillOpacity: 0.75,
                                    weight: 1,
                                    color: '#000'
                                });
                            }
                        });

                        content += `</table>`;
                        dropdown.innerHTML = content;
                        dropdown.classList.add('visible');

                        if (fuelType === "electricity" || fuelType === "naturalGas") {
                            updateLegend(fuelType);
                        } 
                    })
                    .catch(error => {
                        console.error("Error fetching utility data:", error);
                    });
            }

        </script>
</body>

</html>
